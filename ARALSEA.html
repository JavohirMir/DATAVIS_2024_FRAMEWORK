<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Aral Sea Overlays (All-in-One)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    crossorigin=""
  />
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #map { width:100vw; height:100vh; }
    .layer-toggle {
      position:absolute; top:10px; left:10px;
      background:rgba(255,255,255,0.9); padding:8px;
      border-radius:4px; font-family:sans-serif; z-index:1000;
      box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .layer-toggle input { margin-right:4px; }
  </style>
</head>
<body>

  <div id="map"></div>
  <div class="layer-toggle">
    <strong>Toggle Layers</strong><br>
    <label><input type="checkbox" data-layer="Occurrence" checked>Occurrence</label><br>
    <label><input type="checkbox" data-layer="Extent"    checked>Max Extent</label><br>
    <label><input type="checkbox" data-layer="Transitions"checked>Transitions</label>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  document.addEventListener('DOMContentLoaded', ()=> {
    // 1) Map & base
    const bounds = [[39.85,50.0],[49.85,70.0]];
    const zoomThreshold = 9;

    const map = L.map('map')
      .fitBounds(bounds);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OSM'
    }).addTo(map);

    // 2) Build dual-res overlays
    function makeDual(name) {
      return {
        small: L.imageOverlay(
          `down/down/${name}_small.png`, bounds,
          {opacity:0.7}
        ),
        big:   L.imageOverlay(
          `down/down/${name}_big.png`,   bounds,
          {opacity:0.7}
        )
      };
    }

    const overlays = {
      Occurrence:  makeDual('occurrence'),
      Extent:      makeDual('extent'),
      Transitions: makeDual('transitions')
    };

    // 3) Add/remove correct resolution
    function addCorrectRes(key) {
      const {small,big} = overlays[key];
      const wantBig = map.getZoom() >= zoomThreshold;
      const toAdd  = wantBig ? big : small;
      const toRem  = wantBig ? small : big;
      if (map.hasLayer(toRem)) map.removeLayer(toRem);
      if (!map.hasLayer(toAdd)) map.addLayer(toAdd);
    }
    function updateAllRes() {
      document.querySelectorAll('.layer-toggle input').forEach(cb=>{
        if (cb.checked) addCorrectRes(cb.getAttribute('data-layer'));
      });
    }

    // 4) Toggle UI
    document.querySelectorAll('.layer-toggle input').forEach(cb => {
      cb.addEventListener('change', ()=> {
        const key = cb.getAttribute('data-layer');
        const {small,big} = overlays[key];
        if (cb.checked) addCorrectRes(key);
        else {
          if (map.hasLayer(small)) map.removeLayer(small);
          if (map.hasLayer(big))   map.removeLayer(big);
        }
      });
    });

    // 5) Unload when off-screen
    map.on('moveend', ()=>{
      const inView = map.getBounds().intersects(L.latLngBounds(bounds));
      Object.values(overlays).forEach(({small,big}) => {
        [small,big].forEach(layer => {
          if (!inView && map.hasLayer(layer)) map.removeLayer(layer);
        });
      });
      if (inView) updateAllRes();
    });

    // 6) Zoomâ€based resolution
    map.on('zoomend', updateAllRes);

    // 7) Initial draw
    updateAllRes();

    // 8) Inline Service Worker registration via Blob
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE = 'aral-overlays-v1';
        self.addEventListener('install', ev => {
          ev.waitUntil(caches.open(CACHE));
        });
        self.addEventListener('fetch', ev => {
          if (ev.request.url.match(/\\.(png|jpg|webp)$/)) {
            ev.respondWith(
              caches.match(ev.request).then(hit =>
                hit || fetch(ev.request).then(res => {
                  const copy = res.clone();
                  caches.open(CACHE).then(c => c.put(ev.request, copy));
                  return res;
                })
              )
            );
          }
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(console.error);
    }
  });
  </script>
</body>
</html>
